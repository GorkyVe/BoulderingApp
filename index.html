<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Boulder Tracker</title>
    <style>
        :root {
            color-scheme: dark;
            --bg: #0b1220;
            --panel: #111a2c;
            --muted: #94a3b8;
            --primary: #60a5fa;
            --accent: #34d399;
            --warning: #f59e0b;
            --danger: #f87171;
            --border: #1f2937;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: radial-gradient(circle at 20% 20%, rgba(96, 165, 250, 0.08), transparent 35%),
                        radial-gradient(circle at 80% 0%, rgba(52, 211, 153, 0.08), transparent 30%),
                        var(--bg);
            color: #e2e8f0;
            font-family: "Inter", system-ui, -apple-system, sans-serif;
            padding: 1.5rem 1rem 2.5rem;
        }

        .container {
            max-width: 760px;
            margin: 0 auto;
            display: grid;
            gap: 1rem;
        }

        header h1 {
            margin: 0;
            font-size: 1.6rem;
            font-weight: 800;
        }

        header p {
            margin: 0.3rem 0 0;
            color: var(--muted);
            line-height: 1.5;
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1rem 1.25rem;
            box-shadow: 0 18px 30px rgba(0, 0, 0, 0.25);
        }

        .row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .btn {
            appearance: none;
            border: none;
            border-radius: 12px;
            padding: 0.8rem 1.1rem;
            font-weight: 700;
            color: #0b1220;
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }

        .btn:active { transform: translateY(1px); }

        .btn-start { background: linear-gradient(135deg, #22d3ee, #34d399); box-shadow: 0 12px 30px rgba(52, 211, 153, 0.3); }
        .btn-stop { background: linear-gradient(135deg, #f59e0b, #ef4444); color: #0b1220; box-shadow: 0 12px 30px rgba(239, 68, 68, 0.35); }
        .btn-secondary { background: #1f2937; color: #e5e7eb; box-shadow: inset 0 0 0 1px #334155; }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            background: rgba(52, 211, 153, 0.1);
            color: #bbf7d0;
            border-radius: 999px;
            padding: 0.35rem 0.7rem;
            font-size: 0.85rem;
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .status.stopped { background: rgba(148, 163, 184, 0.12); color: var(--muted); }

        .info-text { color: var(--muted); font-size: 0.95rem; line-height: 1.5; }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
        }

        .stat {
            background: #0d1727;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.75rem 0.9rem;
        }

        .stat .label { color: var(--muted); font-size: 0.9rem; }
        .stat .value { font-size: 1.6rem; font-weight: 800; margin-top: 0.15rem; }

        .reading {
            font-size: 2.4rem;
            font-weight: 900;
            letter-spacing: -0.02em;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.75rem;
            border-radius: 999px;
            background: #0d1727;
            border: 1px solid var(--border);
            color: var(--muted);
            font-weight: 600;
        }

        canvas {
            width: 100%;
            background: #0d1727;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        #accelGraph { height: 140px; }
        .impact-graph { height: 80px; }

        .legend { display: flex; gap: 0.75rem; color: var(--muted); flex-wrap: wrap; font-size: 0.9rem; }
        .legend span { display: inline-flex; align-items: center; gap: 0.35rem; }
        .legend .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

        .list { display: grid; gap: 0.75rem; }
        .item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            padding: 0.85rem 1rem;
            border-radius: 12px;
            background: #0d1727;
            border: 1px solid var(--border);
        }

        .item .meta { color: var(--muted); font-size: 0.9rem; }
        .item .force { font-weight: 800; color: var(--warning); }

        .badge { padding: 0.25rem 0.6rem; border-radius: 10px; font-weight: 700; font-size: 0.85rem; border: 1px solid var(--border); }
        .badge.flash { color: #c4b5fd; background: rgba(196, 181, 253, 0.12); border-color: rgba(196, 181, 253, 0.35); }
        .badge.top { color: #86efac; background: rgba(134, 239, 172, 0.12); border-color: rgba(134, 239, 172, 0.35); }
        .badge.queued { color: var(--muted); background: rgba(148, 163, 184, 0.12); }

        .alert {
            border-radius: 12px;
            padding: 0.85rem 1rem;
            font-weight: 600;
            margin: 0.5rem 0;
        }

        .alert.error { background: rgba(248, 113, 113, 0.15); border: 1px solid rgba(248, 113, 113, 0.4); }
        .alert.warn { background: rgba(245, 158, 11, 0.12); border: 1px solid rgba(245, 158, 11, 0.35); }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            display: grid;
            place-items: center;
            padding: 1.25rem;
            z-index: 50;
        }

        .modal-content {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 18px 30px rgba(0, 0, 0, 0.35);
        }

        .grade-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 0.5rem;
        }

        .grade-option { position: relative; }
        .grade-input { position: absolute; opacity: 0; }

        .grade-label {
            display: block;
            padding: 0.55rem 0.5rem;
            text-align: center;
            border-radius: 10px;
            background: #1f2937;
            border: 1px solid var(--border);
            font-weight: 700;
            cursor: pointer;
            color: #e5e7eb;
        }

        .grade-input:checked + .grade-label { background: #22d3ee; color: #0b1220; border-color: #22d3ee; }

        .flex-between { display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Boulder Tracker</h1>
            <p>Simplified session tracker to monitor landings, log force, and grade climbs when you are ready.</p>
        </header>

        <div id="permissionError" class="alert error hidden">Motion sensor access denied. Enable it in your browser settings.</div>
        <div id="unsupportedError" class="alert warn hidden">This device does not report motion data.</div>

        <div class="card">
            <div class="flex-between">
                <div class="row">
                    <span id="sessionStatus" class="status stopped">‚óè Stopped</span>
                    <span class="pill">Session time <strong id="trackingTime">00:00</strong></span>
                </div>
                <button id="sessionBtn" class="btn btn-start">Start session</button>
            </div>
            <p class="info-text" style="margin-top: 0.75rem;">Keep the phone stable in a pocket or waistband. Landings with notable spikes will be queued for grading.</p>
        </div>

        <div id="liveMonitor" class="card hidden">
            <div class="flex-between">
                <div>
                    <div class="label" style="color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; font-size: 0.8rem;">Current acceleration</div>
                    <div id="currentAccel" class="reading">0.0 m/s¬≤</div>
                </div>
                <span class="pill">Tracking force</span>
            </div>
            <div style="margin: 1rem 0 0.75rem;">
                <canvas id="accelGraph" width="600" height="140"></canvas>
            </div>
            <div class="legend">
                <span><span class="dot" style="background:#f97316;"></span>Rest ~2</span>
                <span><span class="dot" style="background:#38bdf8;"></span>Climb ~8</span>
                <span><span class="dot" style="background:#ef4444;"></span>Landing ‚â• 15</span>
            </div>
        </div>

        <div class="card">
            <div class="stat-grid">
                <div class="stat">
                    <div class="label">Total climbs</div>
                    <div id="totalClimbs" class="value">0</div>
                </div>
                <div class="stat">
                    <div class="label">Flashes</div>
                    <div id="flashCount" class="value">0</div>
                </div>
                <div class="stat">
                    <div class="label">Tops</div>
                    <div id="topCount" class="value">0</div>
                </div>
            </div>
        </div>

        <div id="historyCard" class="card">
            <div class="flex-between" style="margin-bottom: 0.5rem;">
                <h3 style="margin: 0;">Climb queue</h3>
                <span id="queueInfo" class="pill">No climbs yet</span>
            </div>
            <div id="climbList" class="list"></div>
        </div>
    </div>

    <div id="logModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex-between" style="margin-bottom: 0.5rem;">
                <h3 style="margin: 0;">Grade this climb</h3>
                <button class="btn btn-secondary" onclick="cancelLog()">Close</button>
            </div>
            <p class="info-text">Captured landing force</p>
            <div id="peakForce" class="reading" style="margin: 0.25rem 0 0.75rem;">0.0 m/s¬≤</div>

            <div style="display: grid; gap: 0.5rem;">
                <div>
                    <div class="label" style="color: var(--muted); margin-bottom: 0.35rem;">Success type</div>
                    <div class="row">
                        <button class="btn btn-secondary" onclick="logClimb('flash')">Flash</button>
                        <button class="btn btn-secondary" onclick="logClimb('top')">Top</button>
                    </div>
                </div>

                <div>
                    <div class="label" style="color: var(--muted); margin-bottom: 0.35rem;">Grade</div>
                    <div class="grade-grid">
                        <div class="grade-option">
                            <input type="radio" name="grade" value="3" id="grade3" class="grade-input">
                            <label for="grade3" class="grade-label">3</label>
                        </div>
                        <div class="grade-option">
                            <input type="radio" name="grade" value="4" id="grade4" class="grade-input">
                            <label for="grade4" class="grade-label">4</label>
                        </div>
                        <div class="grade-option">
                            <input type="radio" name="grade" value="5" id="grade5" class="grade-input">
                            <label for="grade5" class="grade-label">5</label>
                        </div>
                        <div class="grade-option">
                            <input type="radio" name="grade" value="6a" id="grade6a" class="grade-input">
                            <label for="grade6a" class="grade-label">6a</label>
                        </div>
                        <div class="grade-option">
                            <input type="radio" name="grade" value="6b" id="grade6b" class="grade-input">
                            <label for="grade6b" class="grade-label">6b</label>
                        </div>
                        <div class="grade-option">
                            <input type="radio" name="grade" value="6c" id="grade6c" class="grade-input">
                            <label for="grade6c" class="grade-label">6c</label>
                        </div>
                        <div class="grade-option">
                            <input type="radio" name="grade" value="7a" id="grade7a" class="grade-input">
                            <label for="grade7a" class="grade-label">7a</label>
                        </div>
                        <div class="grade-option">
                            <input type="radio" name="grade" value="7b" id="grade7b" class="grade-input">
                            <label for="grade7b" class="grade-label">7b</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isTracking = false;
        let currentAccel = 0;
        let peakForce = 0;
        let accelHistory = [];
        let climbs = [];
        let cooldown = false;
        let wakeLock = null;
        let startTime = null;
        let timerInterval = null;
        let currentClimbId = null;
        let inClimb = false;
        let currentClimb = null;

        const GRAVITY = 9.81;
        const REST_THRESHOLD = 2;
        const CLIMB_THRESHOLD = 8;
        const LANDING_THRESHOLD = 15;
        const HISTORY_LENGTH = 60;

        const sessionBtn = document.getElementById('sessionBtn');
        const sessionStatus = document.getElementById('sessionStatus');
        const liveMonitor = document.getElementById('liveMonitor');
        const logModal = document.getElementById('logModal');
        const canvas = document.getElementById('accelGraph');
        const ctx = canvas.getContext('2d');

        function computeAccel(event) {
            const linear = event.acceleration;
            if (linear && [linear.x, linear.y, linear.z].some(v => v !== null)) {
                const x = linear.x || 0;
                const y = linear.y || 0;
                const z = linear.z || 0;
                return Math.sqrt(x * x + y * y + z * z);
            }

            const gravitySource = event.accelerationIncludingGravity;
            if (!gravitySource) return null;

            const gx = gravitySource.x || 0;
            const gy = gravitySource.y || 0;
            const gz = gravitySource.z || 0;
            const magnitude = Math.sqrt(gx * gx + gy * gy + gz * gz);
            return Math.max(0, magnitude - GRAVITY);
        }

        async function startTracking() {
            if (isTracking) return;

            if (typeof DeviceMotionEvent !== 'undefined') {
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    try {
                        const response = await DeviceMotionEvent.requestPermission();
                        if (response === 'granted') {
                            await beginTracking();
                        } else {
                            document.getElementById('permissionError').classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error('Permission error:', error);
                        document.getElementById('permissionError').classList.remove('hidden');
                    }
                } else {
                    await beginTracking();
                }
            } else {
                document.getElementById('unsupportedError').classList.remove('hidden');
            }
        }

        async function beginTracking() {
            isTracking = true;
            accelHistory = [];
            startTime = Date.now();
            inClimb = false;
            currentClimb = null;

            sessionBtn.textContent = 'Stop session';
            sessionBtn.classList.remove('btn-start');
            sessionBtn.classList.add('btn-stop');
            sessionStatus.textContent = '‚óè Tracking';
            sessionStatus.classList.remove('stopped');
            liveMonitor.classList.remove('hidden');

            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) {
                console.log('Wake lock not supported or failed:', err);
            }

            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);

            window.addEventListener('devicemotion', handleMotion);
        }

        function updateTimer() {
            if (!startTime) return;
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('trackingTime').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function stopTracking() {
            if (!isTracking) return;

            isTracking = false;
            window.removeEventListener('devicemotion', handleMotion);

            if (wakeLock) {
                wakeLock.release().then(() => { wakeLock = null; });
            }

            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            startTime = null;
            inClimb = false;
            currentClimb = null;

            liveMonitor.classList.add('hidden');
            sessionBtn.textContent = 'Start session';
            sessionBtn.classList.add('btn-start');
            sessionBtn.classList.remove('btn-stop');
            sessionStatus.textContent = '‚óè Stopped';
            sessionStatus.classList.add('stopped');

            currentAccel = 0;
        }

        function handleMotion(event) {
            if (!isTracking) return;

            const totalAccel = computeAccel(event);
            if (totalAccel === null) return;

            currentAccel = totalAccel;
            document.getElementById('currentAccel').textContent = totalAccel.toFixed(1) + ' m/s¬≤';

            accelHistory.push(totalAccel);
            if (accelHistory.length > HISTORY_LENGTH) {
                accelHistory.shift();
            }

            drawGraph();

            if (!inClimb && totalAccel >= CLIMB_THRESHOLD && !cooldown) {
                startClimb();
            }

            if (inClimb) {
                trackClimbSample(totalAccel);

                if (totalAccel >= LANDING_THRESHOLD && !cooldown) {
                    completeClimb();
                }
            }
        }

        function startClimb() {
            inClimb = true;
            currentClimb = {
                id: Date.now(),
                timestamp: new Date(),
                success: null,
                grade: null,
                force: 0,
                samples: []
            };

            currentClimbId = currentClimb.id;
        }

        function trackClimbSample(value) {
            if (!currentClimb) return;
            currentClimb.force = Math.max(currentClimb.force, value);
            currentClimb.samples.push(value);

            if (currentClimb.samples.length > HISTORY_LENGTH) {
                currentClimb.samples.shift();
            }
        }

        function completeClimb() {
            if (!currentClimb) return;

            cooldown = true;
            inClimb = false;
            peakForce = currentClimb.force;
            climbs.unshift(currentClimb);
            updateUI();
            showLogModal(currentClimb);

            setTimeout(() => {
                cooldown = false;
            }, 2500);

            currentClimb = null;
        }

        function drawGraph() {
            ctx.fillStyle = '#0b1220';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const maxVal = Math.max(...accelHistory, LANDING_THRESHOLD);
            const thresholds = [
                { value: REST_THRESHOLD, color: '#f97316' },
                { value: CLIMB_THRESHOLD, color: '#38bdf8' },
                { value: LANDING_THRESHOLD, color: '#ef4444', dashed: true }
            ];

            thresholds.forEach(threshold => {
                const y = canvas.height - (threshold.value / maxVal) * canvas.height;
                ctx.strokeStyle = threshold.color;
                ctx.setLineDash(threshold.dashed ? [4, 4] : [2, 4]);
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            });
            ctx.setLineDash([]);

            if (accelHistory.length > 1) {
                ctx.strokeStyle = '#34d399';
                ctx.lineWidth = 2;
                ctx.beginPath();

                accelHistory.forEach((val, i) => {
                    const x = (i / HISTORY_LENGTH) * canvas.width;
                    const y = canvas.height - (val / maxVal) * canvas.height;

                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });

                ctx.stroke();
            }
        }

        function renderImpactGraph(targetCanvas, samples = [], force = 0) {
            if (!targetCanvas) return;

            const localCtx = targetCanvas.getContext('2d');
            localCtx.fillStyle = '#0d1727';
            localCtx.fillRect(0, 0, targetCanvas.width, targetCanvas.height);

            if (!samples.length) return;

            const maxVal = Math.max(...samples, force, LANDING_THRESHOLD);
            const minVal = 0;
            const range = Math.max(maxVal - minVal, 1);
            const stepX = targetCanvas.width / Math.max(samples.length - 1, 1);

            localCtx.strokeStyle = '#ef4444';
            localCtx.setLineDash([4, 4]);
            const landingY = targetCanvas.height - ((LANDING_THRESHOLD - minVal) / range) * targetCanvas.height;
            localCtx.beginPath();
            localCtx.moveTo(0, landingY);
            localCtx.lineTo(targetCanvas.width, landingY);
            localCtx.stroke();
            localCtx.setLineDash([]);

            localCtx.strokeStyle = '#38bdf8';
            localCtx.lineWidth = 2;
            localCtx.beginPath();

            samples.forEach((value, index) => {
                const x = index * stepX;
                const y = targetCanvas.height - ((value - minVal) / range) * targetCanvas.height;

                if (index === 0) {
                    localCtx.moveTo(x, y);
                } else {
                    localCtx.lineTo(x, y);
                }
            });

            localCtx.stroke();

            const peakValue = Math.max(...samples);
            const peakIndex = samples.lastIndexOf(peakValue);
            const peakX = peakIndex * stepX;
            const peakY = targetCanvas.height - ((peakValue - minVal) / range) * targetCanvas.height;

            localCtx.fillStyle = '#f59e0b';
            localCtx.beginPath();
            localCtx.arc(peakX, peakY, 4, 0, Math.PI * 2);
            localCtx.fill();
        }

        function showLogModal(climb = null) {
            const forceValue = climb ? climb.force : peakForce;
            document.getElementById('peakForce').textContent = Number(forceValue).toFixed(1) + ' m/s¬≤';
            logModal.classList.remove('hidden');
        }

        function gradeClimb(id) {
            const climb = climbs.find(c => c.id === id);
            if (!climb) return;

            currentClimbId = climb.id;
            peakForce = climb.force;
            showLogModal(climb);
        }

        function logClimb(success) {
            const gradeInput = document.querySelector('input[name="grade"]:checked');
            if (!gradeInput) {
                alert('Please select a grade');
                return;
            }

            const climb = climbs.find(c => c.id === currentClimbId);
            if (!climb) {
                alert('No climb selected to grade.');
                return;
            }

            climb.success = success;
            climb.grade = gradeInput.value;
            climb.force = Number(climb.force);

            updateUI();
            cancelLog();
        }

        function cancelLog() {
            logModal.classList.add('hidden');
            const gradeInputs = document.querySelectorAll('input[name="grade"]');
            gradeInputs.forEach(input => input.checked = false);
            currentClimbId = null;
        }

        function updateUI() {
            const total = climbs.length;
            const flashes = climbs.filter(c => c.success === 'flash').length;
            const tops = climbs.filter(c => c.success === 'top').length;
            const queued = climbs.filter(c => !c.success || !c.grade).length;

            document.getElementById('totalClimbs').textContent = total;
            document.getElementById('flashCount').textContent = flashes;
            document.getElementById('topCount').textContent = tops;

            const queueInfo = document.getElementById('queueInfo');
            if (queued > 0) {
                queueInfo.textContent = `${queued} queued to grade`;
            } else if (total > 0) {
                queueInfo.textContent = 'All climbs graded';
            } else {
                queueInfo.textContent = 'No climbs yet';
            }

            const climbList = document.getElementById('climbList');
            climbList.innerHTML = '';

            climbs.forEach(climb => {
                const item = document.createElement('div');
                item.className = 'item';

                const isGraded = climb.success && climb.grade;
                const label = isGraded ? (climb.success === 'flash' ? 'Flash' : 'Top') : 'Queued';
                const badgeClass = isGraded ? (climb.success === 'flash' ? 'flash' : 'top') : 'queued';
                const gradeText = isGraded ? `Grade ${climb.grade}` : 'Waiting for grade';
                const time = climb.timestamp.toLocaleTimeString();
                const forceText = Number(climb.force).toFixed(1) + ' m/s¬≤';
                const graphId = `impact-${climb.id}`;

                item.innerHTML = `
                    <div style="flex:1;">
                        <div class="row" style="gap:0.4rem;">
                            <span class="badge ${badgeClass}">${label}</span>
                            <span class="badge">${gradeText}</span>
                        </div>
                        <div class="meta">${time}</div>
                        <canvas class="impact-graph" id="${graphId}" width="260" height="80"></canvas>
                    </div>
                    <div class="row">
                        <div style="text-align: right;">
                            <div class="force">${forceText}</div>
                            <div class="meta">Landing force</div>
                        </div>
                        ${!isGraded ? '<button class="btn btn-secondary grade-btn">Grade</button>' : ''}
                    </div>
                `;

                if (!isGraded) {
                    const gradeBtn = item.querySelector('.grade-btn');
                    gradeBtn.addEventListener('click', () => gradeClimb(climb.id));
                }

                const graphCanvas = item.querySelector(`#${graphId}`);
                renderImpactGraph(graphCanvas, climb.samples || [climb.force], climb.force);

                climbList.appendChild(item);
            });
        }

        sessionBtn.addEventListener('click', () => {
            if (isTracking) {
                stopTracking();
            } else {
                startTracking();
            }
        });

        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible' && isTracking && !wakeLock) {
                try {
                    if ('wakeLock' in navigator) {
                        wakeLock = await navigator.wakeLock.request('screen');
                    }
                } catch (err) {
                    console.log('Failed to re-acquire wake lock:', err);
                }
            }
        });
    </script>
</body>
</html>
